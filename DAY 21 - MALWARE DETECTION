21 - Malware Detection

There are multiple antivirus softwares which are running on the systems and you have the data of how many malware they have detected  in each run.  You need to find out how many malware each software has detected in their latest run and what is the difference between the number of malwares detected in latest run and the second last run for each software. 

Please note that list only the softwares which have run for atleast 2 times and have detected atleast 10 malware in the latest run.

Table: malware(primary key : software_id,run_date)
column name	      datatype
software_id	      int
run_date	      datetime
malware_detected      int

Expected output:
software_id	latest_run_count	difference_to_previous
101	        12	                2

SOLUTION:

WITH CTE AS
(
    SELECT 
        software_id
    FROM malware
    GROUP BY 1
    HAVING COUNT(*) > 1
),

CTE2 AS
(
    SELECT 
        software_id,
        malware_detected,
        ROW_NUMBER() OVER(PARTITION BY software_id ORDER BY run_date DESC) AS row_num
    FROM malware
)

SELECT 
    CTE2.software_id,
    CTE2.malware_detected AS latest_run_count,
    CTE2.malware_detected - (
        SELECT malware_detected 
    FROM CTE2 
    WHERE row_num = 2
    ) AS difference_to_previous
FROM CTE
JOIN CTE2 
ON CTE.software_id = CTE2.software_id
WHERE row_num = 1 AND CTE2.malware_detected >= 10
